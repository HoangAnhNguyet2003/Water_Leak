<div class="meter-manager-container">
  <!-- Header Section -->
  <div class="header-section">
    <div class="header-left">
      <div class="icon-container">
        <i class="fas fa-tachometer-alt"></i>
      </div>
      <h1 class="page-title">Quản lý đồng hồ nước</h1>
    </div>

    <div class="header-actions">
      <!-- Search Box -->
      <div class="search-container">
        <input
          type="text"
          class="search-input"
          placeholder="Tìm kiếm tên đồng hồ..."
          [value]="searchTerm()"
          (input)="onSearchChange($any($event.target).value)">
        <button class="search-btn">
          <i class="fas fa-search"></i>
        </button>
      </div>

      <div class="filter-container">
        <select
          class="filter-select"
          [value]="selectedStatus()"
          (change)="onStatusFilterChange($any($event.target).value)">
          <option value="">Tất cả trạng thái</option>
          <option value="normal">Hoạt động</option>
          <option value="anomaly">Bất thường</option>
          <option value="lost_connection">Mất kết nối</option>
        </select>
      </div>

      <!-- Clear Filter Button -->
      <button class="clear-filter-btn" (click)="clearFilters()">
        <i class="fas fa-times"></i>
        Xóa bộ lọc
      </button>

      <!-- Add Meter Button -->
      <button class="add-meter-btn" (click)="showAddMeterPopup()">
        <i class="fas fa-plus"></i>
        Thêm đồng hồ
      </button>
    </div>
  </div>

  <!-- Table Container -->
  <div class="table-container">
    <!-- Result Counter -->
    <div class="result-counter" *ngIf="allMeterMetaData().length > 0">
      <span class="result-text">
        Hiển thị {{ filteredMeterData().length }} / {{ filteredMeterData().length }} đồng hồ
      </span>
    </div>

    <!-- Table Wrapper với thanh kéo -->
    <div class="table-wrapper">
      <table class="meter-table">
        <thead class="table-header">
          <tr>
            <th class="name-col">Tên đồng hồ</th>
            <th class="address-col">Chi nhánh</th>
            <th class="status-col">Trạng thái</th>
            <th class="installation-date-col">Ngày lắp đặt</th>
            <th class="actions-col">Thao tác</th>
          </tr>
        </thead>
      </table>

      <!-- Scrollable Table Body -->
      <div class="table-body-wrapper">
        <table class="meter-table">
          <tbody>
            <ng-container *ngFor="let meter of filteredMeterData(); let i = index">
              <tr class="meter-row">
                <td class="name-col">
                  <span class="meter-name">{{ meter.name }}</span>
                </td>
                <td class="address-col">
                  <span class="branch-name">{{ meter.branchName }}</span>
                </td>
                <td class="status-col">
                  <span class="status-badge" [class]="'status-' + meter.status">
                    {{ getStatusLabel(meter.status) }}
                  </span>
                </td>
                <td class="installation-date-col">
                  <span class="installation-date">{{ formatInstallationDate(meter.installationDate) }}</span>
                </td>
                <td class="actions-col">
                  <div class="action-dropdown">
                    <button class="dropdown-toggle" (click)="toggleDropdown(i)">
                      <i class="fas fa-chevron-down" [class.rotated]="activeDropdown() === i"></i>
                    </button>
                  </div>
                </td>
              </tr>
              <!-- Dropdown Details Row -->
              <tr *ngIf="activeDropdown() === i" class="dropdown-row">
                <td colspan="5" class="dropdown-cell">
                  <app-meter-dropdown-details
                    [meter]="meter"
                    [isVisible]="true"
                    (removeMeter)="onRemoveMeter($event)"
                    (close)="closeDropdown()">
                  </app-meter-dropdown-details>
                </td>
              </tr>
            </ng-container>
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Empty State -->
  <div *ngIf="filteredMeterData().length === 0 && allMeterMetaData().length > 0" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-search"></i>
    </div>
    <h3>Không tìm thấy kết quả</h3>
    <p>Không có đồng hồ nào phù hợp với bộ lọc hiện tại.</p>
    <button class="clear-filter-btn" (click)="clearFilters()">
      <i class="fas fa-times"></i>
      Xóa bộ lọc
    </button>
  </div>

  <!-- No Data State -->
  <div *ngIf="allMeterMetaData().length === 0" class="empty-state">
    <div class="empty-icon">
      <i class="fas fa-tachometer-alt"></i>
    </div>
    <h3>Không có đồng hồ</h3>
    <p>Chưa có đồng hồ nào trong hệ thống.</p>
  </div>
</div>

<!-- Add Meter Form Popup -->
<app-add-meter-form
  [isVisible]="showAddMeterForm()"
  (meterAdded)="onMeterAdded($event)"
  (cancel)="onAddMeterCancel()">
</app-add-meter-form>
