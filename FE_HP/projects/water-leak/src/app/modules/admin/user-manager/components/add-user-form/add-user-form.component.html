<div class="popup-overlay" *ngIf="isVisible && !showConfirmPopup && !showSuccessPopup" (click)="onCancel()">
  <div class="popup-container" (click)="$event.stopPropagation()">
    <div class="popup-header">
      <h3>Th√™m ng∆∞·ªùi d√πng m·ªõi</h3>
      <button class="close-btn" (click)="onCancel()">√ó</button>
    </div>

    <form class="popup-form" (ngSubmit)="onSubmit()" #userForm="ngForm">
      <div class="form-row">
        <div class="form-group">
          <label for="username">Username <span class="required">*</span></label>
          <input
            type="text"
            id="username"
            name="username"
            class="form-input"
            [(ngModel)]="newUser.username"
            required
            placeholder="Nh·∫≠p username">
        </div>

        <div class="form-group">
          <label for="role">Vai tr√≤ <span class="required">*</span></label>
          <select
            id="role"
            name="role"
            class="form-select"
            [(ngModel)]="newUser.roleName"
            (ngModelChange)="onRoleChange($event)"
            required>
            <option [value]="UserRole.Admin">Administrator</option>
            <option [value]="UserRole.Company">T·ªïng c√¥ng ty</option>
            <option [value]="UserRole.Branch">Chi nh√°nh</option>
          </select>
        </div>
        <div class="form-group">
          <label for="branch">Chi nh√°nh</label>
          <ng-container *ngIf="newUser.roleName === UserRole.Admin || newUser.roleName === UserRole.Company; else branchSelect">
            <div class="fixed-branch">Kh√¥ng x√°c ƒë·ªãnh</div>
          </ng-container>
          <ng-template #branchSelect>
            <select id="branch" name="branch" class="form-select" [(ngModel)]="newUser.branchId">
              <option value="">Ch·ªçn chi nh√°nh (t√πy ch·ªçn)</option>
              <option *ngFor="let b of branches$ | async" [value]="b.id">{{ b.name }}</option>
            </select>
          </ng-template>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label for="password">M·∫≠t kh·∫©u <span class="required">*</span></label>
          <div class="password-input-container">
            <input
              [type]="showPassword ? 'text' : 'password'"
              id="password"
              name="password"
              class="form-input"
              [(ngModel)]="newUser.password"
              required
              placeholder="Nh·∫≠p m·∫≠t kh·∫©u">
            <button type="button" class="password-toggle-btn" (click)="togglePasswordVisibility($event)">
              <span *ngIf="!showPassword">üëÅÔ∏è</span>
              <span *ngIf="showPassword">üôà</span>
            </button>
          </div>
        </div>

        <div class="form-group">
          <label for="confirmPassword">X√°c nh·∫≠n m·∫≠t kh·∫©u <span class="required">*</span></label>
          <div class="password-input-container">
            <input
              [type]="showConfirmPassword ? 'text' : 'password'"
              id="confirmPassword"
              name="confirmPassword"
              class="form-input"
              [(ngModel)]="confirmPassword"
              required
              placeholder="Nh·∫≠p l·∫°i m·∫≠t kh·∫©u"
              [class.error]="!isPasswordValid() && confirmPassword.length > 0">
            <button type="button" class="password-toggle-btn" (click)="toggleConfirmPasswordVisibility($event)">
              <span *ngIf="!showConfirmPassword">üëÅÔ∏è</span>
              <span *ngIf="showConfirmPassword">üôà</span>
            </button>
          </div>
          <div class="error-message" *ngIf="!isPasswordValid() && confirmPassword.length > 0">
            M·∫≠t kh·∫©u x√°c nh·∫≠n kh√¥ng kh·ªõp
          </div>
        </div>
      </div>

      <div class="form-group full-width">
        <label>ƒê·ªìng h·ªì n∆∞·ªõc ƒë∆∞·ª£c qu·∫£n l√Ω</label>
        <div class="water-meters-grid">
          <div
            *ngFor="let meter of availableWaterMeters$ | async"
            class="water-meter-item"
            [class.selected]="isWaterMeterSelected(meter.id)"
            (click)="onMeterClick(meter, $event)">
            <div class="meter-content">
              <div class="meter-main">
                <span class="meter-name">{{ meter.name || ('ƒê·ªìng h·ªì ' + meter.id) }}</span>
              </div>
              <div class="meter-sub">
                <span class="meter-branch">{{ meter.branchName || 'Kh√¥ng r√µ chi nh√°nh' }}</span>
              </div>
            </div>
            <div class="meter-check" *ngIf="isWaterMeterSelected(meter.id)">
              ‚úì
            </div>
          </div>
        </div>
      </div>

      <div class="form-actions">
        <button type="button" class="btn btn-cancel" (click)="onCancel()">
          H·ªßy
        </button>
        <button
          type="submit"
          class="btn btn-primary"
          [disabled]="!userForm.valid || !isPasswordValid()">
          Th√™m ng∆∞·ªùi d√πng
        </button>
      </div>
    </form>
  </div>
</div>

<!-- Popup x√°c nh·∫≠n -->
<lib-popup-confirm
  [isVisible]="showConfirmPopup"
  [mode]="PopupMode.CONFIRM"
  title="X√°c nh·∫≠n th√™m ng∆∞·ªùi d√πng"
  message="B·∫°n c√≥ ch·∫Øc ch·∫Øn mu·ªën th√™m ng∆∞·ªùi d√πng n√†y kh√¥ng?"
  (confirm)="onConfirmAddUser()"
  (cancel)="onCancelConfirm()">
</lib-popup-confirm>

<!-- Popup th√†nh c√¥ng -->
<lib-popup-confirm
  [isVisible]="showSuccessPopup"
  [mode]="PopupMode.SUCCESS"
  title="Th√†nh c√¥ng!"
  message="Ng∆∞·ªùi d√πng ƒë√£ ƒë∆∞·ª£c th√™m th√†nh c√¥ng."
  (confirm)="onCloseSuccess()">
</lib-popup-confirm>

<lib-popup-confirm
  [isVisible]="showErrorPopup"
  [mode]="PopupMode.ERROR"
  title="L·ªói"
  [message]="errorMessage"
  (confirm)="onCloseError()">
</lib-popup-confirm>
