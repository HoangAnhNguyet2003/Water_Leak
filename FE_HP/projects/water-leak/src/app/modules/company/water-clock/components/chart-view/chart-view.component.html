<div class="chart-view-page">
  <!-- Nút thoát cố định -->
  <button class="exit-btn-fixed" (click)="goBack()" title="Quay lại">
    <i class="fas fa-arrow-left"></i>
  </button>

  <!-- Chart Content -->
  <div class="chart-content-wrapper">
    <!-- Chart Tabs -->
    <div class="chart-tabs">
      <button
        class="tab-btn"
        [class.active]="activeChartTab() === 'general'"
        (click)="setActiveTab('general')"
      >
        <i class="fas fa-chart-line"></i>
        Tổng quát
      </button>
      <button
        class="tab-btn"
        [class.active]="activeChartTab() === 'anomaly'"
        (click)="setActiveTab('anomaly')"
      >
        <i class="fas fa-exclamation-triangle"></i>
        Hiển thị bất thường
      </button>
      <button
        class="tab-btn"
        [class.active]="activeChartTab() === 'anomaly-ai'"
        (click)="setActiveTab('anomaly-ai')"
      >
        <i class="fas fa-robot"></i>
        Hiển thị bất thường - AI
      </button>
    </div>

    <!-- Main Chart Section -->
    <div class="main-chart-section">

      <!-- Prediction Button (only show for anomaly tabs) -->
      <button
        *ngIf="shouldShowPredictionButton()"
        class="prediction-toggle-btn"
        (click)="togglePredictionPopup()"
        title="Dữ liệu dự đoán thời gian thực"
      >
        <i class="fas fa-chart-bar"></i>
        <span>Dự đoán</span>
      </button>

      <!-- Chart Header Info -->
      <div class="chart-header-info">
        <h4 class="chart-title">{{ headerTitle() }}</h4>
        <p class="chart-desc">{{ currentChartData().subtitle }}</p>
      </div>

      <!-- Professional Chart (Apex) -->
      <div class="chart-wrapper-large">
        <div class="chart-container-with-grid">
          <div *ngIf="!chartLoaded()" class="chart-empty-hint">Chưa có dữ liệu để hiển thị</div>
          <apx-chart #chart
                     [series]="chartOptions().series"
                     [chart]="chartOptions().chart"
                     [xaxis]="chartOptions().xaxis"
                     [stroke]="chartOptions().stroke"
                     [dataLabels]="chartOptions().dataLabels"
                     [yaxis]="chartOptions().yaxis"
                     [tooltip]="chartOptions().tooltip"
                     [title]="chartOptions().title"
                     [markers]="chartOptions().markers"
                     [colors]="chartOptions().colors"
          ></apx-chart>
        </div>
      </div>

    </div>
  </div>

  <!-- Prediction Popup Modal -->
  <div
    class="prediction-popup-overlay"
    *ngIf="showPredictionPopup()"
    (click)="closePredictionPopup()"
  >
    <div
      class="prediction-popup-modal"
      (click)="$event.stopPropagation()"
    >
      <!-- Popup Header -->
      <div class="prediction-popup-header">
        <h3 class="popup-title">Dữ liệu dự đoán thời gian thực</h3>
        <button class="close-btn" (click)="closePredictionPopup()">
          <i class="fas fa-times"></i>
        </button>
      </div>

      <!-- Popup Content -->
      <div class="prediction-popup-content">
        <!-- Loading Indicator -->
        <div *ngIf="isLoadingPredictions()" class="loading-indicator">
          <i class="fas fa-spinner fa-spin"></i>
          <span>Đang tải dữ liệu dự đoán...</span>
        </div>

        <!-- Data Table -->
        <div *ngIf="!isLoadingPredictions()" class="prediction-table-container">
          <!-- Table Header -->
          <div class="popup-table-header">
            <div class="popup-header-cell">Thời gian</div>
            <div class="popup-header-cell">Lưu lượng</div>
            <div class="popup-header-cell">Trạng thái</div>
          </div>

          <!-- Table Body -->
          <div class="popup-table-body">
            <div
              class="popup-table-row"
              *ngFor="let item of predictionData(); trackBy: trackByPredictionId"
            >
              <div class="popup-data-cell time-cell">{{ item.thoi_gian }}</div>
              <div class="popup-data-cell flow-cell">{{ item.luu_luong }}</div>
              <div class="popup-data-cell status-cell">
                <span class="popup-status-indicator">{{ item.trang_thai }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
