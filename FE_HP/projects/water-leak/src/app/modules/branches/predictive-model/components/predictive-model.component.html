<div class="predictive-container">
  <div class="table-wrapper">
    <div class="topbar">
      <h2 class="title">Bảng theo dõi đồng hồ</h2>

      <div class="filter">
        <!-- chọn đồng hồ -->
        <div class="filter-group">
          <h4>Chọn đồng hồ:</h4>
          <select (change)="onMeterChange($event)">
            <option *ngFor="let meter of data" [value]="meter._id">
              {{ meter.meter_name }}
            </option>
          </select>
        </div>

        <!-- chọn ngày -->
        <div class="filter-group">
          <h4>Chọn ngày:</h4>
          <input type="date" (change)="onDateChange($event)" />
        </div>
      </div>
    </div>

    <div class="meter-info" *ngIf="selectedMeter">
      <h3>Đồng hồ {{ selectedMeter.meter_name }}</h3>
      <div class="model-count" *ngIf="getTotalModelsCount() > 0">
        <span class="badge">{{ getTotalModelsCount() }} mô hình AI</span>
      </div>
    </div>

    <table *ngIf="dates.length > 0 && tableData.models.length > 0">
      <tr>
        <th>MÔ HÌNH DỰ ĐOÁN</th>
        <th *ngFor="let d of dates">{{ d }}</th>
      </tr>

      <tr *ngFor="let m of tableData.models" [class]="m.name === 'Kết luận' ? 'conclusion-row' : ''">
        <td class="model-name">{{ m.name }}</td>
        <td *ngFor="let r of m.results"
            [class]="getPredictionClass(r)"
            [style.color]="getColor(r)">
          {{ r }}
        </td>
      </tr>
    </table>
  </div>
</div>

<!-- Popup hiển thị đồng hồ rò rỉ -->
<div *ngIf="showLeakPopup" class="leak-popup-overlay">
    <div class="leak-popup">
        <div class="leak-header-row">
            <h3 class="blue-title">Đồng hồ ghi nhận rò rỉ</h3>
            <button class="close-btn" (click)="closeLeakPopup()">Đóng</button>
        </div>
        <div class="sort-container">
            <label>Sắp xếp theo mức độ vượt ngưỡng: </label>
            <select [(ngModel)]="sortOrder" (change)="sortLeakingMeters()">
                <option value="" selected>Sắp xếp...</option>
                <option value="desc" selected>Cao nhất trước</option>
                <option value="asc">Thấp nhất trước</option>
            </select>
        </div>
        <div class="leak-table" *ngIf="filteredLeakingMeters.length > 0">
            <div class="leak-header">
                <span>Tên đồng hồ</span>
                <span>Mức độ vượt ngưỡng</span>
            </div>
            <div class="leak-row" *ngFor="let meter of filteredLeakingMeters">
                <span class="meter-name">{{ meter.meter_name }}</span>
                <span class="exceedance">{{ getExceedancePercentage(meter) }}%</span>
            </div>
        </div>
        <div *ngIf="filteredLeakingMeters.length === 0" class="no-leak-message">
            Không có dữ liệu.
        </div>
    </div>
</div>
