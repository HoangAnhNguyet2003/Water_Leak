<div class="predictive-container">
    <div class="table-wrapper">
    <div class="topbar">
    <h2 class="title">B·∫£ng theo d√µi ƒë·ªìng h·ªì</h2>
        <div class="filter">
            <div class="filter-group">
            <h4>ƒê·ªìng h·ªì: </h4>
            <select [(ngModel)]="selectedMeterId" (change)="onMeterChange($event)">
                <option *ngFor="let meter of meters" [value]="meter._id">
                    {{ meter.meter_name }}
                </option>
                </select>

            </div>
        <div class="filter-group">
            <h4>Ch·ªçn ng√†y:</h4>
            <input type="date" [value]="selectedDate" (change)="onDateChange($event)" />
        </div>
        <div class="filter-group">
            <button class="threshold-btn" (click)="openThresholdModal()" [disabled]="!selectedMeterId">
                ƒê·∫∑t ng∆∞·ª°ng cho {{ getTodayText() }}
            </button>
        </div>
            </div>
        </div>
    </div>
    <h3>ƒê·ªìng h·ªì {{ selectedMeter?.meter_name }}</h3>
    <div class="chart-container">
        <canvas id="meterChart"></canvas>
        <div class="threshold-value" *ngIf="thresholdValue > 0">
            <span>Gi√° tr·ªã ng∆∞·ª°ng m·ªõi nh·∫•t: <b>{{ thresholdValue }}</b></span>
        </div>
    </div>
</div>

<!-- Modal ƒë·∫∑t ng∆∞·ª°ng -->
<div class="modal-overlay" *ngIf="showThresholdModal" (click)="closeThresholdModal()">
    <div class="modal-content" (click)="$event.stopPropagation()">
        <div class="modal-header">
            <h3>ƒê·∫∑t ng∆∞·ª°ng cho {{ selectedMeter?.meter_name }}</h3>
            <button class="close-btn" (click)="closeThresholdModal()">&times;</button>
        </div>
        <div class="modal-body">
            <p class="modal-info">Ng√†y: <strong>{{ getTodayText() }}</strong></p>

            <!-- L·ª±a ch·ªçn ph∆∞∆°ng th·ª©c ƒë·∫∑t ng∆∞·ª°ng -->
            <div class="threshold-options">
                <h4>Ch·ªçn c√°ch ƒë·∫∑t ng∆∞·ª°ng:</h4>
                <div class="radio-group">
                    <label class="radio-option">
                        <input type="radio"
                               name="thresholdMethod"
                               value="manual"
                               [(ngModel)]="thresholdMethod"
                               (change)="onMethodChange()">
                        <span class="radio-label">Nh·∫≠p gi√° tr·ªã ng∆∞·ª°ng</span>
                    </label>
                    <label class="radio-option">
                        <input type="radio"
                               name="thresholdMethod"
                               value="yesterday"
                               [(ngModel)]="thresholdMethod"
                               (change)="onMethodChange()">
                        <span class="radio-label">L·∫•y ng∆∞·ª°ng c·ªßa ng√†y h√¥m qua</span>
                    </label>
                </div>
            </div>

            <!-- Input manual threshold -->
            <div class="input-section" *ngIf="thresholdMethod === 'manual'">
                <div class="input-group">
                    <label for="thresholdInput">Gi√° tr·ªã ng∆∞·ª°ng:</label>
                    <input
                        id="thresholdInput"
                        type="number"
                        [(ngModel)]="manualThresholdValue"
                        placeholder="Nh·∫≠p gi√° tr·ªã ng∆∞·ª°ng..."
                        min="0"
                        step="0.01"
                        class="threshold-input">
                </div>
            </div>

            <!-- Yesterday threshold info -->
            <div class="yesterday-section" *ngIf="thresholdMethod === 'yesterday'">
                <div class="info-section">
                    <p class="yesterday-info">
                        <i class="info-icon">üìÖ</i>
                        S·ª≠ d·ª•ng ng∆∞·ª°ng c·ªßa ng√†y {{ getYesterdayText() }}
                        <span *ngIf="yesterdayThreshold" class="threshold-preview">
                            (Gi√° tr·ªã: {{ yesterdayThreshold }})
                        </span>
                        <span *ngIf="!yesterdayThreshold" class="no-threshold">
                            (Ch∆∞a c√≥ ng∆∞·ª°ng cho ng√†y h√¥m qua)
                        </span>
                    </p>
                </div>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn-cancel" (click)="closeThresholdModal()">H·ªßy</button>
            <button
                class="btn-confirm"
                (click)="setThreshold()"
                [disabled]="!isValidThreshold()">
                {{ getConfirmButtonText() }}
            </button>
        </div>
    </div>
</div>

<!-- Popup th√¥ng b√°o -->
<lib-popup-confirm
    [isVisible]="showPopup"
    [title]="popupTitle"
    [message]="popupMessage"
    [mode]="popupMode"
    [confirmText]="'ƒê√≥ng'"
    (confirm)="onPopupConfirm()"
    (cancel)="onPopupCancel()">
</lib-popup-confirm>

